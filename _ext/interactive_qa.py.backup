import html
import uuid

class QuestionBlock:
    """
    Renders a block of interactive questions without any control buttons.
    Use this multiple times throughout a chapter.
    """
    def __init__(self):
        self.questions = []
        self._rendered = False

    def add_question(self, question_id: str, question_text: str):
        """Adds a question to this specific block."""
        if self._rendered:
            print("Warning: Cannot add questions after the block has been rendered.")
            return
        if not question_id or not question_text:
            raise ValueError("question_id and question_text cannot be empty.")
        self.questions.append({'id': question_id, 'text': question_text})

    def render(self) -> str:
        """Generates the HTML for just the questions and textareas."""
        if self._rendered:
            return ""
        if not self.questions:
            return "<p><em>No questions were added to this block.</em></p>"
        self._rendered = True

        question_html_parts = []
        for q in self.questions:
            safe_id = html.escape(q['id'])
            safe_text = html.escape(q['text'])
            question_html_parts.append(f"""
            <div class="question-container mb-8" data-question-id="{safe_id}">
                <label for="{safe_id}" class="block text-lg font-semibold text-gray-700 mb-2">
                    {safe_text}
                </label>
                <textarea id="{safe_id}" rows="5" class="answer-textarea w-full p-3 border border-gray-300 rounded-lg focus:outline-none" placeholder="Type your answer here..."></textarea>
                <div class="save-status text-xs text-gray-500 mt-1 h-4"></div>
            </div>
            """)
        
        return "\n".join(question_html_parts)

class QAManager:
    """
    Renders the master control panel with 'Print All' and 'Clear All' buttons.
    This should only be used ONCE at the end of a page.
    """
    def __init__(self):
        self._rendered = False

    def render(self) -> str:
        """Generates the HTML for the control panel and the master JavaScript."""
        if self._rendered:
            return ""
        self._rendered = True
        
        widget_id = f"qa-manager-{uuid.uuid4().hex}"

        return f"""
        <div id="{widget_id}" class="qa-manager-container my-8 p-6 bg-gray-100 rounded-xl border-2 border-dashed">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">My Answer Summary</h3>
            <p class="text-gray-600 mb-6">Use the buttons below to manage all the answers you've written on this page.</p>
            <div class="flex flex-wrap gap-4 items-center">
                <button class="print-all-button bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 shadow-lg">
                    Print All Answers
                </button>
                <div id="clear-confirm-container" class="flex items-center">
                    <button id="clear-all-button" class="bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-300 transition-all duration-300 shadow-lg">
                        Clear All Answers
                    </button>
                    <button id="confirm-clear-button" class="bg-yellow-500 text-black font-bold py-3 px-6 rounded-lg hover:bg-yellow-600 focus:outline-none focus:ring-4 focus:ring-yellow-300 transition-all duration-300 shadow-lg" style="display: none;">
                        Are you sure? Click to Confirm
                    </button>
                    <span id="cleared-message" class="ml-4 text-green-700 font-semibold" style="display: none;">Answers Cleared!</span>
                </div>
            </div>
        </div>

        <script>
        (function() {{
            console.log("[Q&A Widget] Master script starting...");
            // Ensure this master script only runs once per page.
            if (window.hasQAManagerInitialized) {{
                console.log("[Q&A Widget] Master script already initialized. Stopping.");
                return;
            }}
            window.hasQAManagerInitialized = true;
            console.log("[Q&A Widget] Master script running for the first time.");

            const storageKey = 'jupyterBookAnswers';
            
            // Find ALL textareas on the entire page
            const allTextareas = document.querySelectorAll('.answer-textarea');
            console.log(`[Q&A Widget] Found ${{allTextareas.length}} textareas on the page.`);

            function loadAllAnswers() {{
                const savedAnswers = JSON.parse(localStorage.getItem(storageKey)) || {{}};
                allTextareas.forEach(textarea => {{
                    if (savedAnswers[textarea.id]) {{
                        textarea.value = savedAnswers[textarea.id];
                    }}
                }});
                console.log("[Q&A Widget] All answers loaded.");
            }}

            function saveAnswer(questionId, answer) {{
                const savedAnswers = JSON.parse(localStorage.getItem(storageKey)) || {{}};
                savedAnswers[questionId] = answer;
                localStorage.setItem(storageKey, JSON.stringify(savedAnswers));
                const statusEl = document.querySelector(`[data-question-id="${{questionId}}"] .save-status`);
                if(statusEl) {{
                    statusEl.textContent = 'Saved!';
                    setTimeout(() => {{ statusEl.textContent = ''; }}, 2000);
                }}
            }}
            
            const debouncedSave = (func => {{
                let timeout;
                return (...args) => {{
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), 500);
                }};
            }})(saveAnswer);

            allTextareas.forEach(textarea => {{
                textarea.addEventListener('input', () => {{
                    const statusEl = document.querySelector(`[data-question-id="${{textarea.id}}"] .save-status`);
                    if(statusEl) statusEl.textContent = 'Saving...';
                    debouncedSave(textarea.id, textarea.value);
                }});
            }});

            // --- Control Button Logic ---
            const managerContainer = document.getElementById('{widget_id}');
            if (!managerContainer) {{
                console.error("[Q&A Widget] CRITICAL: Could not find the manager container div.");
                return;
            }}

            const printButton = managerContainer.querySelector('.print-all-button');
            const clearButton = managerContainer.querySelector('#clear-all-button');
            const confirmClearButton = managerContainer.querySelector('#confirm-clear-button');
            const clearedMessage = managerContainer.querySelector('#cleared-message');

            if (printButton) {{
                printButton.addEventListener('click', () => {{
                    console.log("[Q&A Widget] Print button clicked.");
                    let printContents = '<h1 style="font-size: 24pt; font-weight: bold; margin-bottom: 1rem; border-bottom: 1px solid #000; padding-bottom: 0.5rem;">My Answers</h1>';
                    const savedAnswers = JSON.parse(localStorage.getItem(storageKey)) || {{}};
                    
                    document.querySelectorAll('.question-container').forEach(q => {{
                        const qId = q.dataset.questionId;
                        const qText = q.querySelector('label').textContent.trim();
                        const answer = savedAnswers[qId] || 'No answer saved.';
                        
                        printContents += `
                            <div style="break-inside: avoid; margin-bottom: 1.5rem;">
                                <h2 style="font-size: 14pt; font-weight: bold; margin-bottom: 0.5rem;">${{qText}}</h2>
                                <p style="font-size: 12pt; white-space: pre-wrap; margin-top: 0;">${{answer}}</p>
                            </div>
                        `;
                    }});

                    const iframe = document.createElement('iframe');
                    iframe.style.position = 'absolute'; iframe.style.width = '0'; iframe.style.height = '0'; iframe.style.border = '0';
                    document.body.appendChild(iframe);
                    const doc = iframe.contentWindow.document;
                    doc.open();
                    doc.write('<html><head><title>My Answers</title></head><body>' + printContents + '</body></html>');
                    doc.close();
                    setTimeout(() => {{
                        iframe.contentWindow.focus();
                        iframe.contentWindow.print();
                        document.body.removeChild(iframe);
                    }}, 500);
                }});
            }} else {{
                console.error("[Q&A Widget] Print button not found.");
            }}

            if (clearButton && confirmClearButton && clearedMessage) {{
                let confirmTimeout;
                clearButton.addEventListener('click', () => {{
                    clearButton.style.display = 'none';
                    confirmClearButton.style.display = 'inline-block';
                    confirmTimeout = setTimeout(() => {{
                        confirmClearButton.style.display = 'none';
                        clearButton.style.display = 'inline-block';
                    }}, 5000);
                }});

                confirmClearButton.addEventListener('click', () => {{
                    clearTimeout(confirmTimeout);
                    localStorage.removeItem(storageKey);
                    allTextareas.forEach(textarea => {{
                        textarea.value = '';
                    }});
                    confirmClearButton.style.display = 'none';
                    clearButton.style.display = 'inline-block';
                    
                    // Show confirmation message instead of alert
                    clearedMessage.style.display = 'inline';
                    setTimeout(() => {{
                        clearedMessage.style.display = 'none';
                    }}, 3000);
                }});
            }} else {{
                console.error("[Q&A Widget] Clear button components not found.");
            }}

            // Load all answers on initial script run
            loadAllAnswers();
            console.log("[Q&A Widget] Master script finished initialization.");
        }})();
        </script>
        """
#```

### How to Check the Output
#After you rebuild the book and open the chapter page:

#1.  **Open the Developer Console** in your browser. (You can usually do this by right-clicking on the page and selecting "Inspect" or "Inspect Element", then clicking on the "Console" tab).
#2.  You should see several messages that start with `[Q&A Widget]`.

#Please let me know what those messages say. They will tell us if the script is running, if it's finding the button, and if any errors are happening. This will give us the final clue we ne
